<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dist√¢ncia de Mahalanobis Interativa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Visualization & Content Choices: 
        - Defini√ß√£o, F√≥rmula, Intui√ß√£o, Aplica√ß√µes: Text blocks, lists (HTML/Tailwind) to inform. Mathematical formulas rendered with appropriate styling.
        - Visualizador: HTML Canvas for custom 2D drawing of the point, distribution mean, and covariance ellipse. JS for input handling, Mahalanobis distance calculation (including matrix inversion and matrix/vector operations), and dynamic canvas/text updates. The ellipse's shape and orientation are derived from the eigenvalues and eigenvectors of the covariance matrix. Error handling for non-invertible covariance matrices is included.
    -->
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      .tab-button {
        transition: all 0.3s ease;
      }
      .tab-button.active {
        border-color: #0d9488; /* teal-600 */
        color: #0d9488;
        font-weight: 600;
      }
      .content-section {
        display: none;
      }
      .content-section.active {
        display: block;
      }
      .canvas-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        height: 350px;
        margin-left: auto;
        margin-right: auto;
        background-color: #f8fafc; /* slate-50 */
        border-radius: 0.5rem; /* rounded-lg */
        border: 1px solid #e2e8f0; /* slate-200 */
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
      }
      #mahalanobisCanvas {
        display: block;
        width: 100%;
        height: 100%;
      }
      @media (min-width: 640px) {
        /* sm breakpoint */
        .canvas-container {
          height: 400px;
        }
      }
      @media (min-width: 768px) {
        /* md breakpoint */
        .canvas-container {
          height: 450px;
        }
      }
      .formula {
        font-family: "Consolas", "Courier New", Courier, monospace;
        background-color: #f1f5f9; /* slate-100 */
        padding: 0.75rem; /* p-3 */
        border-radius: 0.25rem; /* rounded */
        font-size: 0.875rem; /* text-sm */
        color: #1e293b; /* slate-800 */
        overflow-x: auto;
        white-space: pre;
      }
      .matrix-input input {
        width: 60px; /* Fixed width for matrix inputs */
      }
      .error-message {
        color: #dc2626; /* red-600 */
        font-size: 0.875rem;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-700 antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-teal-600">
          üåê Dist√¢ncia de Mahalanobis Interativa üåê
        </h1>
      </header>

      <nav class="mb-8 flex flex-wrap justify-center gap-2 sm:gap-4">
        <button
          class="tab-button active py-2 px-4 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-600 rounded-t-md"
          data-tab="definicao"
        >
          Defini√ß√£o
        </button>
        <button
          class="tab-button py-2 px-4 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-600 rounded-t-md"
          data-tab="formula"
        >
          F√≥rmula e Termos
        </button>
        <button
          class="tab-button py-2 px-4 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-600 rounded-t-md"
          data-tab="intuicao"
        >
          Intui√ß√£o e Vantagens
        </button>
        <button
          class="tab-button py-2 px-4 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-600 rounded-t-md"
          data-tab="aplicacoes"
        >
          Aplica√ß√µes Pr√°ticas
        </button>
        <button
          class="tab-button py-2 px-4 border-b-2 border-transparent hover:border-teal-500 hover:text-teal-600 rounded-t-md"
          data-tab="visualizador"
        >
          Visualizador Interativo
        </button>
      </nav>

      <main>
        <section
          id="definicao"
          class="content-section active bg-white p-6 rounded-lg shadow-md"
        >
          <h2 class="text-2xl font-semibold text-teal-600 mb-4">
            O que √© a Dist√¢ncia de Mahalanobis?
          </h2>
          <p class="mb-4 leading-relaxed">
            Esta se√ß√£o introduz a Dist√¢ncia de Mahalanobis, uma medida
            estat√≠stica que generaliza a ideia de dist√¢ncia entre um ponto e uma
            distribui√ß√£o de pontos. Voc√™ aprender√° como ela difere da Dist√¢ncia
            Euclidiana ao levar em conta a correla√ß√£o entre vari√°veis e as suas
            respectivas vari√¢ncias, tornando-a uma ferramenta poderosa para
            an√°lise de dados multivariados.
          </p>
          <p class="mb-3 leading-relaxed">
            A <strong>Dist√¢ncia de Mahalanobis</strong> √© uma medida de
            dist√¢ncia estat√≠stica introduzida por P. C. Mahalanobis em 1936. Ela
            mede a dist√¢ncia entre um ponto P e uma distribui√ß√£o D. Uma
            caracter√≠stica chave √© que ela leva em considera√ß√£o a
            <strong>covari√¢ncia</strong> entre as vari√°veis da distribui√ß√£o.
            Isso significa que ela n√£o trata todas as dire√ß√µes no espa√ßo de
            dados da mesma forma, mas sim se ajusta √† "forma" e "orienta√ß√£o" da
            nuvem de pontos da distribui√ß√£o.
          </p>
          <p class="leading-relaxed">
            Diferentemente da Dist√¢ncia Euclidiana, que mede a dist√¢ncia em
            linha reta assumindo que as vari√°veis s√£o independentes e t√™m a
            mesma vari√¢ncia (ou seja, o espa√ßo √© isotr√≥pico), a Dist√¢ncia de
            Mahalanobis transforma os dados em um espa√ßo onde as vari√°veis s√£o
            descorrelacionadas e t√™m vari√¢ncia unit√°ria antes de calcular a
            dist√¢ncia. Isso a torna particularmente √∫til para identificar
            outliers ou medir similaridade em dados multivariados onde as
            vari√°veis podem estar correlacionadas e ter diferentes escalas.
          </p>
        </section>

        <section
          id="formula"
          class="content-section bg-white p-6 rounded-lg shadow-md"
        >
          <h2 class="text-2xl font-semibold text-teal-600 mb-4">
            üí° F√≥rmula da Dist√¢ncia de Mahalanobis e Seus Termos
          </h2>
          <p class="mb-4 leading-relaxed">
            Aqui, detalhamos a express√£o matem√°tica da Dist√¢ncia de Mahalanobis.
            Ser√£o explicados cada componente da f√≥rmula, incluindo o vetor de
            observa√ß√£o, o vetor de m√©dias da distribui√ß√£o e, crucialmente, a
            matriz de covari√¢ncia inversa. Entender esses elementos √©
            fundamental para apreciar como a dist√¢ncia √© calculada e o que ela
            representa.
          </p>

          <div class="mb-6">
            <h3 class="text-xl font-medium text-slate-700 mb-2">
              F√≥rmula Geral
            </h3>
            <p class="mb-2">
              A Dist√¢ncia de Mahalanobis (D<sub>M</sub>) de um vetor de
              observa√ß√£o multivariado <em>x</em> = (x<sub>1</sub>,
              x<sub>2</sub>, ..., x<sub>N</sub>)<sup>T</sup> de um conjunto de
              observa√ß√µes com m√©dia <em>Œº</em> = (Œº<sub>1</sub>, Œº<sub>2</sub>,
              ..., Œº<sub>N</sub>)<sup>T</sup> e matriz de covari√¢ncia
              <em>S</em> √© definida como:
            </p>
            <div class="formula">
              D<sub>M</sub>(x) = ‚àö((x - Œº)<sup>T</sup> S<sup>-1</sup> (x - Œº))
            </div>
            <p class="mt-2 text-sm text-slate-500">
              Muitas vezes, a dist√¢ncia √© referida na sua forma quadr√°tica,
              D<sub>M</sub><sup>2</sup>(x), para evitar a raiz quadrada e
              simplificar c√°lculos.
            </p>
          </div>

          <div>
            <h3 class="text-xl font-medium text-slate-700 mb-3">
              üìù Desvendando os Termos
            </h3>
            <ul class="list-disc list-inside space-y-3 pl-2 leading-relaxed">
              <li>
                <strong>x:</strong> √â o vetor do ponto de observa√ß√£o (o ponto
                para o qual queremos calcular a dist√¢ncia).
              </li>
              <li>
                <strong>Œº (mu):</strong> √â o vetor de m√©dias da distribui√ß√£o de
                refer√™ncia (o "centro" da distribui√ß√£o).
              </li>
              <li>
                <strong>S:</strong> √â a matriz de covari√¢ncia da distribui√ß√£o de
                refer√™ncia. Esta matriz descreve como as diferentes vari√°veis na
                distribui√ß√£o variam juntas.
                <ul class="list-circle list-inside ml-6 mt-1 space-y-1 text-sm">
                  <li>
                    Os elementos na diagonal de S s√£o as vari√¢ncias de cada
                    vari√°vel.
                  </li>
                  <li>
                    Os elementos fora da diagonal s√£o as covari√¢ncias entre
                    pares de vari√°veis.
                  </li>
                </ul>
              </li>
              <li>
                <strong>S<sup>-1</sup>:</strong> √â a inversa da matriz de
                covari√¢ncia (tamb√©m chamada de matriz de precis√£o).
              </li>
              <li>
                <strong>(x - Œº):</strong> √â o vetor de diferen√ßas entre o ponto
                de observa√ß√£o e a m√©dia da distribui√ß√£o.
              </li>
              <li>
                <strong><sup>T</sup> (Transposto):</strong> Indica a
                transposi√ß√£o de um vetor ou matriz. (x - Œº)<sup>T</sup> √© um
                vetor linha.
              </li>
              <li><strong>‚àö :</strong> S√≠mbolo da raiz quadrada.</li>
            </ul>
            <p
              class="mt-4 p-3 bg-sky-50 border-l-4 border-sky-400 text-sky-700 rounded text-sm leading-relaxed"
            >
              <strong>Ess√™ncia:</strong> A Dist√¢ncia de Mahalanobis mede quantas
              "desvios padr√£o generalizados" o ponto <em>x</em> est√° do centro
              <em>Œº</em> da distribui√ß√£o, levando em conta a estrutura de
              correla√ß√£o e vari√¢ncia dos dados definida por <em>S</em>.
            </p>
          </div>
        </section>

        <section
          id="intuicao"
          class="content-section bg-white p-6 rounded-lg shadow-md"
        >
          <h2 class="text-2xl font-semibold text-teal-600 mb-4">
            üß† Intui√ß√£o e Vantagens
          </h2>
          <p class="mb-4 leading-relaxed">
            Por que usar a Dist√¢ncia de Mahalanobis em vez da mais simples
            Dist√¢ncia Euclidiana? Esta se√ß√£o explora a intui√ß√£o por tr√°s dela e
            suas principais vantagens. Discutiremos como ela lida com dados
            correlacionados, diferentes escalas entre vari√°veis e sua efic√°cia
            na detec√ß√£o de outliers multivariados, oferecendo uma perspectiva
            mais robusta sobre a "dist√¢ncia" em espa√ßos de dados complexos.
          </p>
          <ul class="space-y-4">
            <li class="p-3 bg-slate-50 rounded-md">
              <h3 class="font-semibold text-slate-700">
                1. Leva em Conta a Correla√ß√£o
              </h3>
              <p class="text-sm leading-relaxed">
                Se duas vari√°veis s√£o altamente correlacionadas (por exemplo,
                altura e peso), a Dist√¢ncia Euclidiana pode ser enganosa. A
                Dist√¢ncia de Mahalanobis ajusta-se a essa correla√ß√£o. Imagine
                uma nuvem de pontos el√≠ptica: a dist√¢ncia "real" ao longo do
                eixo principal da elipse √© diferente da dist√¢ncia ao longo do
                eixo menor. Mahalanobis entende isso.
              </p>
            </li>
            <li class="p-3 bg-slate-50 rounded-md">
              <h3 class="font-semibold text-slate-700">
                2. Invariante √† Escala
              </h3>
              <p class="text-sm leading-relaxed">
                Se voc√™ mudar a escala de uma vari√°vel (por exemplo, de metros
                para cent√≠metros), a Dist√¢ncia Euclidiana mudar√° drasticamente.
                A Dist√¢ncia de Mahalanobis √© independente da escala das
                vari√°veis porque ela efetivamente "normaliza" cada vari√°vel pela
                sua vari√¢ncia.
              </p>
            </li>
            <li class="p-3 bg-slate-50 rounded-md">
              <h3 class="font-semibold text-slate-700">
                3. Detec√ß√£o de Outliers Multivariados
              </h3>
              <p class="text-sm leading-relaxed">
                Um ponto pode n√£o ser um outlier em nenhuma vari√°vel
                individualmente, mas pode ser um outlier quando as vari√°veis s√£o
                consideradas em conjunto. A Dist√¢ncia de Mahalanobis √© excelente
                para detectar esses outliers multivariados, pois considera a
                "forma" da distribui√ß√£o dos dados.
              </p>
            </li>
            <li class="p-3 bg-slate-50 rounded-md">
              <h3 class="font-semibold text-slate-700">
                4. Espa√ßo Transformado
              </h3>
              <p class="text-sm leading-relaxed">
                Pode-se pensar na Dist√¢ncia de Mahalanobis como o c√°lculo da
                Dist√¢ncia Euclidiana em um espa√ßo transformado, onde os dados
                originais foram rotacionados e escalonados de forma que a matriz
                de covari√¢ncia se torne a matriz identidade (ou seja, as novas
                vari√°veis s√£o descorrelacionadas e t√™m vari√¢ncia unit√°ria).
              </p>
            </li>
            <li class="p-3 bg-slate-50 rounded-md">
              <h3 class="font-semibold text-slate-700">
                Compara√ß√£o com Dist√¢ncia Euclidiana:
              </h3>
              <p class="text-sm leading-relaxed">
                A Dist√¢ncia Euclidiana √© um caso especial da Dist√¢ncia de
                Mahalanobis que ocorre quando a matriz de covari√¢ncia √© a matriz
                identidade (S = I), ou seja, quando as vari√°veis s√£o
                descorrelacionadas e todas t√™m vari√¢ncia 1.
              </p>
            </li>
          </ul>
        </section>

        <section
          id="aplicacoes"
          class="content-section bg-white p-6 rounded-lg shadow-md"
        >
          <h2 class="text-2xl font-semibold text-teal-600 mb-4">
            üéØ Principais Aplica√ß√µes Pr√°ticas
          </h2>
          <p class="mb-6 leading-relaxed">
            Devido √†s suas propriedades √∫nicas, a Dist√¢ncia de Mahalanobis √© uma
            ferramenta valiosa em diversos campos da estat√≠stica e aprendizado
            de m√°quina. Esta se√ß√£o apresentar√° algumas de suas aplica√ß√µes mais
            comuns, como detec√ß√£o de anomalias, classifica√ß√£o de padr√µes e
            an√°lise de clusters, onde a estrutura de covari√¢ncia dos dados √©
            importante.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-50 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-slate-700 mb-2">
                üö® Detec√ß√£o de Outliers (Anomalias)
              </h3>
              <p class="text-sm leading-relaxed">
                Uma das aplica√ß√µes mais comuns. Pontos com alta Dist√¢ncia de
                Mahalanobis em rela√ß√£o ao centro de uma distribui√ß√£o s√£o
                considerados outliers prov√°veis, especialmente em dados
                multivariados.
              </p>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-slate-700 mb-2">
                üß© Classifica√ß√£o de Padr√µes
              </h3>
              <p class="text-sm leading-relaxed">
                Usada como m√©trica de dist√¢ncia em algoritmos de classifica√ß√£o.
                Um novo ponto √© atribu√≠do √† classe cuja Dist√¢ncia de Mahalanobis
                ao centro (m√©dia) da classe √© a menor.
              </p>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-slate-700 mb-2">
                üìä An√°lise de Agrupamento (Clustering)
              </h3>
              <p class="text-sm leading-relaxed">
                Pode ser usada para medir a dissimilaridade entre clusters ou
                entre um ponto e um cluster, especialmente quando os clusters
                t√™m formas el√≠pticas e diferentes orienta√ß√µes.
              </p>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-slate-700 mb-2">
                üè≠ Controle de Qualidade Estat√≠stico
              </h3>
              <p class="text-sm leading-relaxed">
                Para monitorar processos multivariados e detectar quando um
                processo est√° saindo do controle, identificando observa√ß√µes que
                se desviam significativamente do comportamento normal.
              </p>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-slate-700 mb-2">
                üß¨ Bioinform√°tica e Quimiometria
              </h3>
              <p class="text-sm leading-relaxed">
                Na an√°lise de dados de express√£o g√™nica, espectroscopia, entre
                outros, onde os conjuntos de dados s√£o frequentemente
                multivariados e com correla√ß√µes complexas.
              </p>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-slate-700 mb-2">
                üõ∞Ô∏è Sensoriamento Remoto
              </h3>
              <p class="text-sm leading-relaxed">
                Na classifica√ß√£o de pixels em imagens de sat√©lite com base em
                suas assinaturas espectrais multivariadas.
              </p>
            </div>
          </div>
        </section>

        <section
          id="visualizador"
          class="content-section bg-white p-6 rounded-lg shadow-md"
        >
          <h2 class="text-2xl font-semibold text-teal-600 mb-4">
            üî¨ Visualizador Interativo da Dist√¢ncia de Mahalanobis
          </h2>
          <p class="mb-3 leading-relaxed">
            Explore a Dist√¢ncia de Mahalanobis em um ambiente 2D! Defina as
            coordenadas de um <strong>Ponto de Observa√ß√£o (P)</strong>. Em
            seguida, defina os par√¢metros da
            <strong>Distribui√ß√£o de Refer√™ncia</strong>: sua
            <strong>M√©dia (Œº)</strong> e sua
            <strong>Matriz de Covari√¢ncia (S)</strong>. A matriz de covari√¢ncia
            √© definida pela Vari√¢ncia de X (œÉ¬≤x), Vari√¢ncia de Y (œÉ¬≤y) e a
            Covari√¢ncia entre X e Y (œÉxy).
          </p>
          <p class="mb-6 leading-relaxed">
            O gr√°fico mostrar√° o ponto P, a m√©dia Œº, e uma elipse representando
            o contorno de 1 desvio padr√£o da distribui√ß√£o. A Dist√¢ncia de
            Mahalanobis calculada ser√° exibida. Experimente variar os valores,
            especialmente a covari√¢ncia, para ver como a "forma" da distribui√ß√£o
            afeta a dist√¢ncia!
          </p>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
            <div class="md:col-span-1 space-y-4">
              <div>
                <h3 class="text-md font-medium text-slate-700 mb-1">
                  Ponto de Observa√ß√£o P (x, y)
                </h3>
                <div class="flex gap-2">
                  <input
                    type="number"
                    id="pointX"
                    value="3"
                    class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    placeholder="Px"
                  />
                  <input
                    type="number"
                    id="pointY"
                    value="3"
                    class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    placeholder="Py"
                  />
                </div>
              </div>
              <div>
                <h3 class="text-md font-medium text-slate-700 mb-1">
                  M√©dia da Distribui√ß√£o Œº (Œºx, Œºy)
                </h3>
                <div class="flex gap-2">
                  <input
                    type="number"
                    id="meanX"
                    value="0"
                    class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    placeholder="Œºx"
                  />
                  <input
                    type="number"
                    id="meanY"
                    value="0"
                    class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    placeholder="Œºy"
                  />
                </div>
              </div>
              <div>
                <h3 class="text-md font-medium text-slate-700 mb-1">
                  Matriz de Covari√¢ncia S
                </h3>
                <div class="space-y-1">
                  <div class="flex items-center gap-1 matrix-input">
                    <span class="text-sm w-20">Var(X) (œÉ¬≤x):</span>
                    <input
                      type="number"
                      id="varX"
                      value="2"
                      min="0.01"
                      step="0.1"
                      class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    />
                  </div>
                  <div class="flex items-center gap-1 matrix-input">
                    <span class="text-sm w-20">Var(Y) (œÉ¬≤y):</span>
                    <input
                      type="number"
                      id="varY"
                      value="1"
                      min="0.01"
                      step="0.1"
                      class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    />
                  </div>
                  <div class="flex items-center gap-1 matrix-input">
                    <span class="text-sm w-20">Cov(X,Y) (œÉxy):</span>
                    <input
                      type="number"
                      id="covXY"
                      value="0.5"
                      step="0.1"
                      class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"
                    />
                  </div>
                </div>
              </div>
              <div class="mt-4 space-y-2">
                <p class="text-md">
                  <strong>Dist. Mahalanobis (D<sub>M</sub>):</strong>
                </p>
                <p
                  id="mahalanobisDistanceResult"
                  class="font-bold text-teal-600 text-xl"
                >
                  N/A
                </p>
                <p id="mahalanobisError" class="error-message"></p>
                <details class="text-xs text-slate-500">
                  <summary>Detalhes do C√°lculo</summary>
                  <p class="mt-1">
                    <strong>S<sup>-1</sup> (Inversa da Covari√¢ncia):</strong>
                  </p>
                  <pre
                    id="invCovMatrixInfo"
                    class="bg-slate-100 p-1 rounded text-xs"
                  ></pre>
                  <p class="mt-1">
                    <strong>Determinante de S:</strong>
                    <span id="detSInfo"></span>
                  </p>
                </details>
              </div>
            </div>

            <div class="md:col-span-2">
              <div class="canvas-container">
                <canvas id="mahalanobisCanvas"></canvas>
              </div>
              <p class="text-xs text-center mt-2 text-slate-500">
                A elipse representa o contorno de 1 desvio padr√£o da
                distribui√ß√£o.
              </p>
            </div>
          </div>
        </section>
      </main>

      <footer class="text-center mt-12 py-6 border-t border-slate-300">
        <p class="text-sm text-slate-500">
          &copy; <span id="currentYear"></span> Aplica√ß√£o Interativa da Dist. de
          Mahalanobis. Fins educacionais.
        </p>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll(".tab-button");
        const contentSections = document.querySelectorAll(".content-section");

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            const targetTab = tab.getAttribute("data-tab");
            contentSections.forEach((section) => {
              section.classList.remove("active");
              if (section.id === targetTab) {
                section.classList.add("active");
              }
            });
            if (targetTab === "visualizador") {
              requestAnimationFrame(() => sizeCanvasAndDraw());
            }
          });
        });

        document.getElementById("currentYear").textContent =
          new Date().getFullYear();

        const pointXInput = document.getElementById("pointX");
        const pointYInput = document.getElementById("pointY");
        const meanXInput = document.getElementById("meanX");
        const meanYInput = document.getElementById("meanY");
        const varXInput = document.getElementById("varX");
        const varYInput = document.getElementById("varY");
        const covXYInput = document.getElementById("covXY");

        const distanceResultEl = document.getElementById(
          "mahalanobisDistanceResult"
        );
        const errorEl = document.getElementById("mahalanobisError");
        const invCovMatrixInfoEl = document.getElementById("invCovMatrixInfo");
        const detSInfoEl = document.getElementById("detSInfo");

        const canvas = document.getElementById("mahalanobisCanvas");
        const ctx = canvas.getContext("2d");

        function calculateAndDraw() {
          errorEl.textContent = "";
          const px = parseFloat(pointXInput.value) || 0;
          const py = parseFloat(pointYInput.value) || 0;
          const mux = parseFloat(meanXInput.value) || 0;
          const muy = parseFloat(meanYInput.value) || 0;
          const varX = parseFloat(varXInput.value);
          const varY = parseFloat(varYInput.value);
          const covXY = parseFloat(covXYInput.value) || 0;

          if (isNaN(varX) || isNaN(varY)) {
            errorEl.textContent = "Vari√¢ncias devem ser n√∫meros.";
            distanceResultEl.textContent = "N/A";
            invCovMatrixInfoEl.textContent = "N/A";
            detSInfoEl.textContent = "N/A";
            clearCanvas();
            return;
          }

          if (varX <= 0 || varY <= 0) {
            errorEl.textContent = "Vari√¢ncias (œÉ¬≤x, œÉ¬≤y) devem ser positivas.";
            distanceResultEl.textContent = "N/A";
            invCovMatrixInfoEl.textContent = "N/A";
            detSInfoEl.textContent = "N/A";
            clearCanvas();
            return;
          }

          const detS = varX * varY - covXY * covXY;
          detSInfoEl.textContent = detS.toFixed(4);

          if (detS <= 0) {
            errorEl.textContent =
              "Determinante da matriz de covari√¢ncia deve ser positivo (S n√£o singular e positiva definida). Verifique os valores de vari√¢ncia e covari√¢ncia.";
            distanceResultEl.textContent = "N/A";
            invCovMatrixInfoEl.textContent = "N/A";
            clearCanvas();
            return;
          }

          const invDetS = 1 / detS;
          const s_inv_00 = invDetS * varY;
          const s_inv_01 = invDetS * -covXY;
          const s_inv_10 = invDetS * -covXY;
          const s_inv_11 = invDetS * varX;

          invCovMatrixInfoEl.textContent = `[[${s_inv_00.toFixed(
            3
          )}, ${s_inv_01.toFixed(3)}]\n [${s_inv_10.toFixed(
            3
          )}, ${s_inv_11.toFixed(3)}]]`;

          const dx = px - mux;
          const dy = py - muy;

          const temp_x = s_inv_00 * dx + s_inv_01 * dy;
          const temp_y = s_inv_10 * dx + s_inv_11 * dy;

          const d_sq = dx * temp_x + dy * temp_y;

          if (d_sq < 0) {
            errorEl.textContent =
              "Dist√¢ncia quadr√°tica negativa. Verifique a matriz de covari√¢ncia.";
            distanceResultEl.textContent = "N/A";
            clearCanvas();
            return;
          }
          const distance = Math.sqrt(d_sq);
          distanceResultEl.textContent = distance.toFixed(4);

          drawVisuals(px, py, mux, muy, varX, varY, covXY);
        }

        function clearCanvas() {
          const width = canvas.width;
          const height = canvas.height;
          ctx.clearRect(0, 0, width, height);
        }

        function drawVisuals(px, py, mux, muy, varX, varY, covXY) {
          const width = canvas.width;
          const height = canvas.height;
          ctx.clearRect(0, 0, width, height);

          const a = varX;
          const b = covXY;
          const d = varY;

          const trace = a + d;
          const determinant = a * d - b * b;

          const term_sqrt = Math.sqrt(
            Math.max(0, trace * trace - 4 * determinant)
          );
          const eigVal1 = (trace + term_sqrt) / 2;
          const eigVal2 = (trace - term_sqrt) / 2;

          let eigVec1x, eigVec1y, angle;
          if (b === 0) {
            eigVec1x = a >= d ? 1 : 0;
            eigVec1y = a >= d ? 0 : 1;
          } else {
            eigVec1x = b;
            eigVec1y = eigVal1 - a;
          }
          angle = Math.atan2(eigVec1y, eigVec1x);

          const radiusX_ellipse = Math.sqrt(Math.max(0, eigVal1));
          const radiusY_ellipse = Math.sqrt(Math.max(0, eigVal2));

          const padding = 50;
          const pointsForScaling = [
            { x: mux, y: muy },
            { x: px, y: py },
            {
              x: mux + radiusX_ellipse * Math.cos(angle) * 2,
              y: muy + radiusX_ellipse * Math.sin(angle) * 2,
            },
            {
              x: mux - radiusX_ellipse * Math.cos(angle) * 2,
              y: muy - radiusX_ellipse * Math.sin(angle) * 2,
            },
            {
              x: mux + radiusY_ellipse * Math.cos(angle + Math.PI / 2) * 2,
              y: muy + radiusY_ellipse * Math.sin(angle + Math.PI / 2) * 2,
            },
            {
              x: mux - radiusY_ellipse * Math.cos(angle + Math.PI / 2) * 2,
              y: muy - radiusY_ellipse * Math.sin(angle + Math.PI / 2) * 2,
            },
          ];

          let minDataX = Infinity,
            maxDataX = -Infinity,
            minDataY = Infinity,
            maxDataY = -Infinity;
          pointsForScaling.forEach((pt) => {
            minDataX = Math.min(minDataX, pt.x);
            maxDataX = Math.max(maxDataX, pt.x);
            minDataY = Math.min(minDataY, pt.y);
            maxDataY = Math.max(maxDataY, pt.y);
          });

          let dataWidth = maxDataX - minDataX;
          let dataHeight = maxDataY - minDataY;
          if (dataWidth === 0) dataWidth = 10;
          if (dataHeight === 0) dataHeight = 10;

          const scaleX = (width - 2 * padding) / dataWidth;
          const scaleY = (height - 2 * padding) / dataHeight;
          const scale = Math.min(scaleX, scaleY) * 0.9;

          const canvasOriginX =
            padding + (width - 2 * padding - dataWidth * scale) / 2;
          const canvasOriginY =
            padding + (height - 2 * padding - dataHeight * scale) / 2;

          const toCanvasX = (dataX) =>
            canvasOriginX + (dataX - minDataX) * scale;
          const toCanvasY = (dataY) =>
            height - (canvasOriginY + (dataY - minDataY) * scale);

          ctx.beginPath();
          ctx.strokeStyle = "#cbd5e1";
          ctx.lineWidth = 1;
          const xAxisY =
            minDataY <= 0 && maxDataY >= 0
              ? toCanvasY(0)
              : height - padding / 2;
          ctx.moveTo(padding / 2, xAxisY);
          ctx.lineTo(width - padding / 2, xAxisY);
          const yAxisX =
            minDataX <= 0 && maxDataX >= 0 ? toCanvasX(0) : padding / 2;
          ctx.moveTo(yAxisX, padding / 2);
          ctx.lineTo(yAxisX, height - padding / 2);
          ctx.stroke();

          ctx.beginPath();
          ctx.ellipse(
            toCanvasX(mux),
            toCanvasY(muy),
            radiusX_ellipse * scale,
            radiusY_ellipse * scale,
            -angle,
            0,
            2 * Math.PI
          );
          ctx.strokeStyle = "#38bdf8";
          ctx.lineWidth = 2;
          ctx.stroke();

          const cMeanX = toCanvasX(mux);
          const cMeanY = toCanvasY(muy);
          ctx.beginPath();
          ctx.arc(cMeanX, cMeanY, 5, 0, 2 * Math.PI);
          ctx.fillStyle = "#0ea5e9";
          ctx.fill();
          ctx.fillStyle = "#0369a1";
          ctx.fillText(
            `Œº(${mux.toFixed(1)},${muy.toFixed(1)})`,
            cMeanX + 8,
            cMeanY - 8
          );

          const cPx = toCanvasX(px);
          const cPy = toCanvasY(py);
          ctx.beginPath();
          ctx.arc(cPx, cPy, 5, 0, 2 * Math.PI);
          ctx.fillStyle = "#f97316";
          ctx.fill();
          ctx.fillStyle = "#c2410c";
          ctx.fillText(
            `P(${px.toFixed(1)},${py.toFixed(1)})`,
            cPx + 8,
            cPy - 8
          );
        }

        function sizeCanvasAndDraw() {
          const style = getComputedStyle(canvas.parentElement);
          canvas.width = parseInt(style.width);
          canvas.height = parseInt(style.height);
          calculateAndDraw();
        }

        [
          pointXInput,
          pointYInput,
          meanXInput,
          meanYInput,
          varXInput,
          varYInput,
          covXYInput,
        ].forEach((input) => {
          input.addEventListener("input", calculateAndDraw);
        });

        sizeCanvasAndDraw();

        new ResizeObserver(() => {
          sizeCanvasAndDraw();
        }).observe(canvas.parentElement);
      });
    </script>
  </body>
</html>
